<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>شبیه‌ساز همپوشانی عکس‌های هوایی</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --panel-bg: rgba(255, 255, 255, 0.8);
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --accent: #e11d48;
    --accent-hover: #be123c;
    --border: #e2e8f0;
    --shadow-sm: 0 4px 12px rgba(0,0,0,0.08);
    --shadow-md: 0 10px 30px rgba(0,0,0,0.12);
    --shadow-lg: 0 20px 50px rgba(0,0,0,0.18);
    --radius: 16px;
    --transition: all 0.3s ease;
}

@media (prefers-color-scheme: dark) {
    :root {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --panel-bg: rgba(30, 41, 59, 0.8);
        --text-primary: #f1f5f9;
        --text-secondary: #cbd5e1;
        --border: #334155;
    }
}

body {
    font-family: "Vazir", "Segoe UI", system-ui, sans-serif;
    background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
    color: var(--text-primary);
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    line-height: 1.7;
}

@media (prefers-color-scheme: dark) {
    body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }
}

h1 {
    font-size: 2.2rem;
    margin: 20px 0 10px;
    font-weight: 700;
}

.container {
    max-width: 1100px;
    margin: 0 auto;
}

.panel {
    background: var(--panel-bg);
    backdrop-filter: blur(12px);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin: 16px 0;
    box-shadow: var(--shadow-md);
    text-align: center;
}

.controls {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
    align-items: center;
    font-size: 1rem;
}

.controls label {
    font-weight: 600;
    color: var(--text-secondary);
    min-width: 80px;
}

input[type="number"], input[type="range"] {
    padding: 8px 12px;
    border-radius: 10px;
    border: 2px solid var(--border);
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 1rem;
    transition: var(--transition);
}

input[type="number"]:focus, input[type="range"]:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(225, 29, 72, 0.15);
}

input[type="range"] {
    accent-color: var(--accent);
    width: 200px;
}

button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
}

button:hover {
    background: var(--accent-hover);
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}

.upload-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin: 20px 0;
}

.upload-grid input[type="file"] {
    padding: 12px;
    background: var(--bg-secondary);
    border: 2px dashed var(--border);
    border-radius: 12px;
    transition: var(--transition);
}

.upload-grid input[type="file"]:hover {
    border-color: var(--accent);
}

#frame-container {
    position: relative;
    margin: 30px auto;
    width: fit-content;
    overflow: hidden;
    border-radius: 20px;
    box-shadow: var(--shadow-lg);
}

#frame {
    position: relative;
    width: 900px;
    height: 900px;
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    overflow: hidden;
    transition: transform 0.4s ease;
}

@media (prefers-color-scheme: dark) {
    #frame {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }
}

.photo {
    position: absolute;
    width: 300px;
    height: 300px;
    object-fit: cover;
    border-radius: 16px;
    box-shadow: var(--shadow-md);
    cursor: grab;
    user-select: none;
    transition: var(--transition);
    transform-origin: center;
}

.photo:hover {
    box-shadow: var(--shadow-lg);
    z-index: 10;
}

.photo:active {
    cursor: grabbing;
    transform: scale(1.05) !important;
}

.photo-number {
    position: absolute;
    top: 12px;
    right: 12px;
    background: rgba(0,0,0,0.7);
    color: white;
    font-weight: bold;
    padding: 6px 12px;
    border-radius: 10px;
    font-size: 14px;
    backdrop-filter: blur(6px);
}

.grid-line {
    position: absolute;
    background: rgba(100, 116, 139, 0.3);
    z-index: 1;
    pointer-events: none;
}

.grid-line.vertical { width: 2px; height: 100%; }
.grid-line.horizontal { height: 2px; width: 100%; }

.overlap-line {
    position: absolute;
    background: linear-gradient(90deg, transparent, var(--accent) 50%, transparent);
    box-shadow: 0 0 15px rgba(225, 29, 72, 0.5);
    z-index: 8;
    pointer-events: none;
    border-radius: 4px;
}

.overlap-line.vertical { width: 5px; height: 100%; }
.overlap-line.horizontal { height: 5px; width: 100%; }

.info-bar {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--accent);
}

@media (max-width: 980px) {
    #frame {
        width: 95vw;
        height: 95vw;
    }
    .photo {
        width: calc(95vw / 3);
        height: calc(95vw / 3);
    }
    .controls {
        flex-direction: column;
    }
    input[type="range"] {
        width: 100%;
    }
}
</style>
</head>
<body>

<div class="container">
    <h1>شبیه‌ساز همپوشانی عکس‌های هوایی</h1>
    
    <div class="panel info-bar">
        ✈️ مقیاس پیشنهادی: ۱:۵۰۰۰ | ارتفاع پرواز: ۱۵۰۰ متر | شبکه ۳×۳
    </div>

    <div class="panel controls">
        <div>
            <label>همپوشانی طولی:</label>
            <input type="number" id="longitudinal" value="60" min="0" max="95"> %
        </div>
        <div>
            <label>همپوشانی عرضی:</label>
            <input type="number" id="transverse" value="30" min="0" max="95"> %
        </div>
        <div>
            <label>شفافیت:</label>
            <input type="range" id="opacity" min="0.3" max="1" step="0.05" value="0.8">
        </div>
        <div>
            <button onclick="zoom(1.15)">زوم +</button>
            <button onclick="zoom(0.85)">زوم −</button>
            <button onclick="resetZoom()">ریست زوم</button>
            <button onclick="exportImage()">خروجی PNG</button>
            <button onclick="resetAll()">ریست کامل</button>
        </div>
    </div>

    <div class="panel">
        <p style="margin:8px 0; color:var(--text-secondary);">بارگذاری عکس‌ها (شماره‌گذاری از بالا-راست به چپ):</p>
        <div class="upload-grid">
            <input type="file" accept="image/*" data-i="0">
            <input type="file" accept="image/*" data-i="1">
            <input type="file" accept="image/*" data-i="2">
            <input type="file" accept="image/*" data-i="3">
            <input type="file" accept="image/*" data-i="4">
            <input type="file" accept="image/*" data-i="5">
            <input type="file" accept="image/*" data-i="6">
            <input type="file" accept="image/*" data-i="7">
            <input type="file" accept="image/*" data-i="8">
        </div>
    </div>

    <div id="frame-container">
        <div id="frame"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
const frame = document.getElementById("frame");
const container = document.getElementById("frame-container");
let images = Array(9).fill(null);
let zoomLevel = 1;
const baseSize = 300;

function getSteps() {
    const lon = document.getElementById("longitudinal").value / 100;
    const tra = document.getElementById("transverse").value / 100;
    return {
        x: baseSize * (1 - tra),
        y: baseSize * (1 - lon)
    };
}

function render() {
    frame.innerHTML = "";
    drawGrid();
    drawOverlapLines();

    const {x, y} = getSteps();
    const opacity = document.getElementById("opacity").value;

    images.forEach((src, i) => {
        if (!src) return;

        const row = Math.floor(i / 3);
        const col = i % 3;

        const img = document.createElement("img");
        img.src = src;
        img.className = "photo";
        img.style.left = `${col * x}px`;
        img.style.top = `${row * y}px`;
        img.style.opacity = opacity;

        // شماره عکس
        const label = document.createElement("div");
        label.className = "photo-number";
        label.textContent = i + 1;
        img.appendChild(label);

        makeDraggable(img);
        frame.appendChild(img);
    });
}

function drawGrid() {
    for (let i = 1; i < 3; i++) {
        const v = document.createElement("div");
        v.className = "grid-line vertical";
        v.style.left = `${i * baseSize}px`;
        frame.appendChild(v);

        const h = document.createElement("div");
        h.className = "grid-line horizontal";
        h.style.top = `${i * baseSize}px`;
        frame.appendChild(h);
    }
}

function drawOverlapLines() {
    const {x, y} = getSteps();
    for (let i = 1; i < 3; i++) {
        const v = document.createElement("div");
        v.className = "overlap-line vertical";
        v.style.left = `${i * x}px`;
        frame.appendChild(v);

        const h = document.createElement("div");
        h.className = "overlap-line horizontal";
        h.style.top = `${i * y}px`;
        frame.appendChild(h);
    }
}

function makeDraggable(el) {
    let pos = { x: parseFloat(el.style.left || 0), y: parseFloat(el.style.top || 0) };
    let dragging = false;

    const move = (e) => {
        if (!dragging) return;
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        const rect = frame.getBoundingClientRect();

        let newX = clientX - rect.left - (el.offsetWidth / 2);
        let newY = clientY - rect.top - (el.offsetHeight / 2);

        // محدودیت داخل فریم
        newX = Math.max(0, Math.min(newX, frame.offsetWidth - el.offsetWidth));
        newY = Math.max(0, Math.min(newY, frame.offsetHeight - el.offsetHeight));

        el.style.left = newX + "px";
        el.style.top = newY + "px";
    };

    el.addEventListener("mousedown", (e) => {
        dragging = true;
        e.preventDefault();
    });
    el.addEventListener("touchstart", (e) => {
        dragging = true;
        e.preventDefault();
    });

    document.addEventListener("mousemove", move);
    document.addEventListener("touchmove", move);

    document.addEventListener("mouseup", () => dragging = false);
    document.addEventListener("touchend", () => dragging = false);
}

document.querySelectorAll("input[type=file]").forEach(inp => {
    inp.addEventListener("change", () => {
        const i = inp.dataset.i;
        if (inp.files[0]) {
            images[i] = URL.createObjectURL(inp.files[0]);
            render();
        }
    });
});

["longitudinal", "transverse", "opacity"].forEach(id =>
    document.getElementById(id).addEventListener("input", render)
);

function zoom(factor) {
    zoomLevel = Math.max(0.5, Math.min(zoomLevel * factor, 3));
    frame.style.transform = `scale(${zoomLevel})`;
}

function resetZoom() {
    zoomLevel = 1;
    frame.style.transform = "scale(1)";
}

function resetAll() {
    document.getElementById("longitudinal").value = 60;
    document.getElementById("transverse").value = 30;
    document.getElementById("opacity").value = 0.8;
    images = Array(9).fill(null);
    document.querySelectorAll("input[type=file]").forEach(i => i.value = "");
    resetZoom();
    render();
}

function exportImage() {
    html2canvas(frame, {scale: 2}).then(canvas => {
        const link = document.createElement("a");
        link.download = `aerial_overlap_${Date.now()}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    });
}

// رندر اولیه
render();
</script>

</body>
</html>